---
layout: post
title: Automatically Building Pull Requests from GitHub with TeamCity
categories:
- General
- JetBrains
tags:
- JetBrains
- OSS
- TeamCity
status: publish
type: post
published: true
meta:
  draftfeedback_requests: a:1:{s:13:"5112442000c21";a:3:{s:3:"key";s:13:"5112442000c21";s:4:"time";s:10:"1360151584";s:7:"user_id";s:7:"5078411";}}
  _publicize_pending: '1'
  _elasticsearch_indexed_on: '2013-02-06 11:24:47'
---
<h3>Scenario</h3> <p>You're running an OSS project* and someone makes a pull request. You've got two choices:</p>

<ul> <li>Merge and Pray  <li>Pull to local branch, build, run tests and merge if all OK </li></ul>

<p>What do you do? Well, what is it going to be?</p>

<p><img style="display:inline;" alt="Dealing with Pull Request" src="{{ site.images }}/dealwithmerge.png" width="510" height="600"></p>
<p>I know what <em>I'd like</em> to do, and GitHub makes it so so tempting:</p>
<p><img title="mergerequestgithub.png" border="0" alt="Merge Pull Request" src="{{ site.images }}/mergerequestgithub.png" width="600" height="43"></p>
<p>But unfortunately I go with the second option.</p>
<p>That's a pain, specially if you do a quick code-review and things look decent. Yet you still need to make sure that it builds and all tests pass.</p>
<p>Well, luckily for me, and <a href="https://twitter.com/hhariri/status/298436432765259777">my ability to continuously interfere in conversations</a>,
I found out that there is a better way. And what's even nicer, is that it's also possible with TeamCity.</p>
<p>*This applies to non-OSS too</p> <h3>Automatically Building All Pull Requests</h3>
<p>What I want to do is have TeamCity automatically build all Pull Requests for me of my main repository, and notify me if it is successful. And I want this to happen without me having to configure every single fork as a repository in TeamCity, because like that, it wouldn't be manageable. Here's a diagram explaining it:</p> <p><img style="display:inline;" title="TCFlowDiagram.png" border="0" alt="TC Flow Diagram" src="{{ site.images }}/tcflowdiagram.png" width="600" height="446"></p> <p>This will drastically improve the workflow since we no longer have to manually create a local branch of the pull request, check it, build it and only then merge it.</p> <h3>Configuring TeamCity</h3> <p>Setting up TeamCity to do this is really simple. It actually only requires one thing: configuring the <strong>Branch Specification</strong> under the VCS root:</p> <p><img style="display:inline;" title="TCGitConfig.png" border="0" alt="TC Git Config" src="{{ site.images }}/tcgitconfig.png" width="600" height="423"></p> <p>Let's see what this means and why it works. When a pull request is made, GitHub automatically creates a reference that holds the pull request as well as one that is a merge with the master branch. What we're saying to TeamCity is to monitor this branch, in addition to the main branch. In this syntax, <em>pull</em> refers to the pull request. The * refers to ANY pull request, and the <em>merge</em> indicates that we're interested in the pull request merged with the master branch. This means that when TeamCity builds, it will build the branch that was merged. If we want to build the branch, without merging, we could use the following:</p> <p><strong>+:refs/pull/*/head</strong></p> <p>So to recap, adding <em>merge</em> builds the result of the merge, and adding <em>head</em>, just the pull request without the merge.</p> <p>The result of these builds show up in TeamCity like so:</p> <p><img style="display:inline;" title="TCResult1.png" border="0" alt="TC Result 1" src="{{ site.images }}/tcresult1.png" width="600" height="139"></p> <p>where the number denotes the pull request. Now, we can actually make this a bit nicer by allowing us to see whether the particular request was the result of a merge or just the branch itself. For that, we can specify the following in the Branch Specification</p> <p><img style="display:inline;" title="TCAltConfig.png" border="0" alt="TC Alt Config" src="{{ site.images }}/tcaltconfig.png" width="600" height="151"></p> <p>with TeamCity now indicating whether this was a merge or head:</p> <p><img style="display:inline;" title="TCResult2.png" border="0" alt="TC Result 2" src="{{ site.images }}/tcresult2.png" width="456" height="216"></p> <p>In addition, TeamCity also provides us with a Dropdown, where we can filter all the different pull requests:</p> <p><img title="Filter.png" border="0" alt="Filter" src="{{ site.images }}/filter.png" width="284" height="293"></p> <h3>Seeing notifications on the Pull Request</h3> <p>As this is a normal build, like any other build, we can configure TeamCity to receive notifications via email, tray icon, etc, both on successful builds as well as failed builds. However, there is one other thing that we can do: see the result of the build on the Pull Request page on GitHub. In order for this to happen, we do need to install a plugin for TeamCity which currently doesn't ship out of the box. This plugin, written by <a href="https://twitter.com/jonnyzzz">Eugene Petrenko</a> uses some hooks GitHub provides to add notification information on the Pull Request page.</p> <p>To install it, <a href="https://github.com/jonnyzzz/TeamCity.GitHub">download the plugin as a zip file</a> and place it in the plugins folder of the server and restart the server.</p> <p>Once that's installed, we can now display build status information on the GitHub pull request by adding a Build Feature to our Build Steps:</p> <p><img style="display:inline;" title="BuildFeature.png" border="0" alt="Build Feature" src="{{ site.images }}/buildfeature.png" width="600" height="300"></p> <p>and filling in some simple configuration parameters:</p> <p><a href="{{ site.images }}/image1-1.png"><img style="background-image:none;border-bottom:0;border-left:0;padding-left:0;padding-right:0;display:inline;border-top:0;border-right:0;padding-top:0;" title="image" border="0" alt="image" src="{{ site.images }}/image_thumb1-1.png" width="507" height="473"></a></p> <p>And with that, we can see the status on the Pull Request page on GitHub.</p> <p><a href="{{ site.images }}/image123.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;" title="image" border="0" alt="image" src="{{ site.images }}/image_thumb-1.png" width="1512" height="415"></a></p> <p>* If you're running your OSS project on <a href="http://teamcity.codebetter.com">TeamCity at CodeBetter</a>, you now have this plugin available.</p> <h3>Summary</h3> <p>Although my example was based on <a href="http://blogs.jetbrains.com/teamcity/2013/01/25/teamcity-8-0-code-name-gaya-eap-is-open/">TeamCity 8.0 which is currently in EAP</a>, this feature also works with TeamCity 7.1.3+ (and even <a href="http://www.lshift.net/blog/2013/01/13/continuous-integration-for-github-pull-requests-with-teamcity">previously covered by others</a>). The examples are also based on OSS projects, but you can apply the same workflow to private repositories also, hopefully making things a little bit easier.</p>
