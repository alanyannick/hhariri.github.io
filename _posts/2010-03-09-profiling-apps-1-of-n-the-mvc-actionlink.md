---
layout: post
title: 'Profiling Apps 1 of N: The MVC ActionLink'
categories: []
tags:
- dotTrace
status: publish
type: post
published: true
meta:
  reddit: a:2:{s:5:"count";i:0;s:4:"time";i:1365335712;}
  _elasticsearch_indexed_on: '2010-03-09 21:30:00'
comments: true
---
<p>&nbsp;</p> <p>I’m starting a new series of blogs posts on profiling, where we’ll try and cover common bottlenecks and how to identify them in your applications. However, before delving deeper into the subject, let me make a small but important observation:</p> <p align="center"><br><em>Your bottleneck is probably not your for loop</em></p> <p align="left"><br>Now, replace that <em>for loop </em>with <em>switch statement</em>, an older version of some outdated algorithm that you feel needs optimizing, or that retched collection of classes that would perform better if you were using an array to loop through them, and you’ll end up with the same observation.</p> <h3>Premature Optimization</h3> <p align="left"><br>When dealing with business applications, it is unusual for major performance problems to be pinpointed down to specific portions of code or a concrete implementation of an algorithm. Usually most of the issues are bottlenecks at the data level, network level or purely down to how a business decision is made.</p> <p>Whether we use an ORM or use SQL directly, incorrectly formulated queries are one of the most predominant causes of bad performance. Not understanding concepts such as Lazy or Eager loading when using an ORM can be disastrous to the performance of an application, and are usually portrayed as “ORM XYZ sucks at performance”. </p> <p>Network bandwidth and latency are other issues; when dealing with web applications for instance, having large pages (i.e. ViewState) or rendering Javascript directly without using script files, are a common problem for performance penalties. Making heavy calls to the server when very little information is required (i.e. UpdatePanel used incorrectly) are again main causes for concern.</p> <p>In many cases, design decisions we make early can affect the performance of our applications, and it is important to identify these concerns and address them correctly. Using an ORM, <a href="http://nhprof.com">profiling it</a>, understanding how Ajax really works and not worrying about <a href="http://jquery.org">working with Javascript</a>, or using an <a href="http://nservicebus.com">asynchronous architecture</a> when dealing with long running business processes are many ways to avoid bad performance in the long run.</p> <p>On the other hand, what we shouldn’t do is focus on micro-optimizations, on trying to make the most efficient, yet completely undecipherable algorithm to calculate the probability of winning money when buying lottery tickets, when the underlying problem is a bottleneck caused by a bad query. This kind of approach is often referred to as Premature Optimization, and can be disastrous for a project.</p> <h3>When it does boil down to code</h3> <p>Having said all that, there are times when we need better performance after having eliminated all the obvious causes, and need to discover why something is not performing as well as it should be. Of course, these concerns are greater when the nature of our application demands highly optimized code. In these cases, it is crucial to understand how things work in order to solve the problem. As a old-school boy, before we had managed libraries and drag-n-drop, I’m also a firm believer that it is always important to understand how things work under the covers, even if it is to just improve one self's knowledge.</p> <p>Therefore, in these series of blog posts about performance, I’m going to focus on the latter, examining the details of code and how some things can perform better than others. So given the disclaimer, let’s get down to business.</p> <p>In order to do performance tuning, you need to use a tool. Setting stopwatches doesn’t work, because as <a href="http://www.devspace.com/">Christian Gross</a> so rightly pointed out during one of his talks, and I semi-quote: ‘if you’re using a stopwatch, you think you know where the bottleneck is. Most of the time, you’re wrong’.&nbsp; If you are setting using a manual approach of setting calling Start and Stop, trying to time something, you’re assuming you know that the performance problem is located in a particular point, and many times it is not that point. So you end up having to place these kind of diagnostic codes in various places in your code, and soon it becomes a maintenance nightmare. Fortunately, there are tools that can profile your application in a non-invasive manner. When talking about SQL profiling, there’s <a href="http://nhprof.com">NHProfiler</a> for instance. When it comes to code performance profiling, the two most known ones are <a href="http://www.red-gate.com/products/index.htm">ANT Profiler</a> and <a href="http://www.jetbrains.com/dottrace">dotTrace</a>. I’m going to be using dotTrace. I used it before joining <a href="http://www.jetbrains.com">JetBrains</a> and continue to use it now that I’m at JetBrains. I’ll be using <a href="http://www.jetbrains.net/confluence/display/NetProf/4.0+Nightly+Builds">version 4.0</a> which is currently (at the time of writing this post), in <a href="http://www.jetbrains.net/confluence/display/NetProf/4.0+Nightly+Builds">Early Access Program</a> and with Beta being released very soon.</p> <h3>To Express or not Express</h3> <p>Those that are familiar with it ASP.NET MVC know it relies heavily on the use of strings in many areas. For instance, when defining ActionLinks, you write</p> <p align="center"><br>Html.ActionLink(“Home”, “Index”, “Home”)</p> <p align="left"><br>where the first parameter is the link text, the second the Action and the third parameter is the Controller. The problem with this of course is that if you type either the second or third parameter incorrectly, you won’t know until runtime. Even if you build your views it won’t help.</p> <p align="left"><br>An alternative is to use Expression based Html Helpers (<a href="/blogengine/post/2010/01/20/ASPNET-Support-in-ReSharper-5.aspx">another option</a> is to use <a href="http://www.jetbrains.com/resharper">ReSharper</a> of course :)). These are strongly-typed ActionLinks that do not ship out of the box with ASP.NET MVC, but are available as a separate download in the <a href="http://aspnet.codeplex.com/releases/view/39978">MVC Futures</a> assembly, which can be thought of as a kind of sandbox for Microsoft to play with. Some of the functionalities in this library have eventually made it to the main core, such as <em>RenderPartial</em>, which was in fact there from pretty much the early Previews of MVC 1, and didn’t get all the excitement until it made it into the core in version 2. Other functionality, including the expression based ActionLinks haven’t made it in yet. When using these helpers, the previous link would be:</p> <p align="center"><br>Html.ActionLink&lt;HomeController&gt;( a =&gt; a.Index, “Home”)</p> <p align="left"><br>In principle this looks good, and begs the question of why it is not in the main core. Well I don’t know the exact reason, but one could potentially be due to it’s performance. Several people have talked about the difference in terms of rendering when using this version as opposed to the standard string based one. You can find one of those <a href="http://codeclimber.net.nz/archive/2009/04/17/the-performances-implications-of-the-expression-tree-based-actionlink-helper.aspx">posts here</a>. What I thought I’d do, is actually see how much difference in speed there is between one and the other.</p> <h3>The Project</h3> <p>I’m using a very simple project for this profiling. It’s your standard ASP.NET MVC 2 application. On Index page, I’ve added two blocks of code:</p> <div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:23dd89a5-1ba6-4e74-9e95-9d4c09d76120" class="wlWriterSmartContent"> <div style="border-bottom:#000080 1px solid;border-left:#000080 1px solid;font-family:'Courier New',courier,monospace;color:#000000;font-size:10pt;border-top:#000080 1px solid;border-right:#000080 1px solid;"> <div style="background:#dddddd 0 0;overflow:auto;"> <ol style="background:#000000 0 0;margin:0 0 0 2.5em;padding:0 0 0 5px;"> <li><span style="background:#000000 0 0;color:#6897bb;">&lt;%</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">for</span><span style="color:#ffffff;"> (</span><span style="color:#cc7832;">int</span><span style="color:#ffffff;"> i = </span><span style="color:#6897bb;">0</span><span style="color:#ffffff;">; i &lt; </span><span style="color:#6897bb;">1000</span><span style="color:#ffffff;">; i++)</span>  <li><span style="color:#ffffff;">{</span><span style="background:#000000 0 0;color:#6897bb;">%&gt;</span>  <li>&nbsp; <span style="color:#ffffff;"></span><span style="background:#000000 0 0;color:#6897bb;">&lt;%</span><span style="color:#ffffff;">= Html.ActionLink(</span><span style="color:#a5c25c;">"Link "</span><span style="color:#ffffff;"> + i, </span><span style="color:#a5c25c;">"Index"</span><span style="color:#ffffff;">, </span><span style="color:#a5c25c;">"Home"</span><span style="color:#ffffff;">)</span><span style="background:#000000 0 0;color:#6897bb;">%&gt;</span><span style="color:#ffffff;">&lt;</span><span style="color:#e8bc64;">br</span><span style="color:#ffffff;"> /&gt;</span>  <li>&nbsp; <span style="color:#ffffff;"></span><span style="background:#000000 0 0;color:#6897bb;">&lt;%</span>  <li><span style="color:#ffffff;">}</span><span style="color:#ffffff;"> </span><span style="background:#000000 0 0;color:#6897bb;">%&gt;</span>  <li>&nbsp; <li><span style="background:#000000 0 0;color:#6897bb;">&lt;%</span><span style="color:#ffffff;"> </span><span style="color:#cc7832;">for</span><span style="color:#ffffff;"> (</span><span style="color:#cc7832;">int</span><span style="color:#ffffff;"> i = </span><span style="color:#6897bb;">0</span><span style="color:#ffffff;">; i &lt; </span><span style="color:#6897bb;">1000</span><span style="color:#ffffff;">; i++)</span>  <li><span style="color:#ffffff;">{</span><span style="background:#000000 0 0;color:#6897bb;">%&gt;</span>  <li>&nbsp; <span style="color:#ffffff;"></span><span style="background:#000000 0 0;color:#6897bb;">&lt;%</span><span style="color:#ffffff;">= Html.ActionLink&lt;</span><span style="color:#ffc66d;">HomeController</span><span style="color:#ffffff;">&gt;(a =&gt; a.Index(), </span><span style="color:#a5c25c;">"Link "</span><span style="color:#ffffff;"> + i)</span><span style="background:#000000 0 0;color:#6897bb;">%&gt;</span><span style="color:#ffffff;">&lt;</span><span style="color:#e8bc64;">br</span><span style="color:#ffffff;"> /&gt;</span>  <li>&nbsp; <span style="color:#ffffff;"></span><span style="background:#000000 0 0;color:#6897bb;">&lt;%</span>  <li><span style="color:#ffffff;">}</span><span style="color:#ffffff;"> </span><span style="background:#000000 0 0;color:#6897bb;">%&gt;</span> </li></ol></div></div></div> <p align="left"><br>The first <em>for </em>loop will render out 1000 links using the string based ActionLink version, whereas the second loop will do the same using the expression-based one.</p> <p align="left"><br>What we want to do now is run this and see how long it takes for each loop to complete.</p> <h3>Setting up dotTrace Profiler</h3> <p>Working with <a href="http://www.jetbrains.com/dottrace">dotTrace</a> is as easy as it gets. There are two ways to profile an application: Standalone or integrated within Visual Studio. In the case of the former, you can start up dotTrace outside of Visual Studio and point to an application to profile. On the other hand if you have it integrated inside Visual Studio, then all you need to do is click on the Profile menu option:</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/134.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="13" border="0" alt="13" src="http://hhariri.files.wordpress.com/2010/11/13_thumb2.png" width="285" height="137"></a> </p> <p>Once we do that, we get a dialog box that provides us a series of options, mainly to do with the type of profiling we are going to perform.</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/144.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="14" border="0" alt="14" src="http://hhariri.files.wordpress.com/2010/11/14_thumb2.png" width="364" height="249"></a> </p> <p>Since we’re profiling a web application, we can either use the Development Server or Internet Information Server. In our case we’re going to use the former. dotTrace will automatically pick up the server settings as well as fill out the physical path for our application.</p> <p>Next come the profiling options. The basic settings are Profiling Type and Meter Kind. The first parameter indicates how profiling will take place. It can be:</p> <ul> <li>Sampling: dotTrace will do frequent analysis of calls stacks. It’s the least intrusive, has very little impact on performance, but gives approximate timing.  <li>Tracing: dotTrace receives notifications from the CLR on entry/exit of methods. More precise timing and call information.  <li>Line-by-Line: dotTrace logs times for every statement in methods. Most precise but also has higher impact on performance. </li></ul> <p>Tracing is normally the recommended option. Meter Kind defines how dotTrace logs the time: CPU instruction or Performance counter (uses the Windows API and samples are hardware independent).</p> <h3>Profiling our application</h3> <p>Once we have everything setup, we can start profiling our app. dotTrace will launch a small panel that allows us to control data sampling.</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/154.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="15" border="0" alt="15" src="http://hhariri.files.wordpress.com/2010/11/15_thumb2.png" width="269" height="214"></a> </p> <p>dotTrace does not by default however launch the browser. In order to do so, we need to either click on the WebDev server and Open in Browser or just type the URL directly in the browser.</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/164.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="16" border="0" alt="16" src="http://hhariri.files.wordpress.com/2010/11/16_thumb2.png" width="193" height="103"></a> </p> <p>The next step is to perform the operations we want to profile and then click on GetSnapshot.</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/174.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="17" border="0" alt="17" src="http://hhariri.files.wordpress.com/2010/11/17_thumb2.png" width="346" height="249"></a> </p> <p>Since in our case, having rendered the <em>Index </em>action performs these operations, once the page has been loaded, we can click on GetSnapshot and have the profiler launched.</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/184.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="18" border="0" alt="18" src="http://hhariri.files.wordpress.com/2010/11/18_thumb2.png" width="364" height="249"></a> </p> <p>I’m not going to get into all of the details of dotTrace in this first post because otherwise it would never end;&nbsp; we’ll cover some of the aspects in future posts. For now, lets focus on our performance test at hand which is the difference between the two types of ActionLinks (string and expression based).</p> <p>The easiest way to find what we are looking for is to use the…you guessed it, Find feature. Ctrl+F will bring up a dialog box similar to ReSharper’s Type location. We can then type ActionLink to filter the list of functions down to the ones that interest us</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/193.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="19" border="0" alt="19" src="http://hhariri.files.wordpress.com/2010/11/19_thumb1.png" width="641" height="114"></a> </p> <p>We can see that there are two versions, as expected. Let’s drill in to the second one first, the string based one. Hitting Enter will find the first location. We can then press F3 until we find the one that interests us. Remember, Site.Master and other references to this call also exist. We’re specifically looking for the loop, the one with 1000 calls</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/203.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="20" border="0" alt="20" src="http://hhariri.files.wordpress.com/2010/11/20_thumb1.png" width="644" height="202"></a> </p> <p>We can see that the <em>ActionLink</em> call takes 121ms for 1000 calls. Drilling in, we can see exactly where the time is spent, and 104ms of that is calling <em>GenerateUrl</em>. Now let’s take a look at the Expression based ActionLink</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/219.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="21" border="0" alt="21" src="http://hhariri.files.wordpress.com/2010/11/21_thumb1.png" width="644" height="137"></a> </p> <p>For the same 1000 calls it takes 140ms, which is an increase of approximately 17%. Diving in once again, we can see that 6ms of this is in the parsing of the expression tree, <em>GetRouteValuesFromExpression. </em>What this function does is merely analyze the expression to extract the ActionName from the parameter. The ControllerName it already has since it’s the concrete type the generic method is invoked with, returning both values in a <em>RouteValueDictionary</em>. As such it then needs to call <em>GenerateRouteLink </em>as opposed to <em>GenerateLink </em>since the former takes a <em>RouteValueDictionary </em>as a parameter, whereas the latter takes strings indicating the controller and action. They ultimately both call <em>GenerateUrl</em>.</p> <h3>Summary</h3> <p>From the results, the difference between the two calls is not that<br>significant for 1000 links. As the number of links increment, the<br>difference between the two does not change significantly. For instance,<br>rendering 10.000 links, has a difference of 50ms between one version<br>and another.What’s interesting that having run the same profiling on previous<br>releases, the difference in time was nearly double, so there seems to<br>have been improvement in this area. And as we can see, sometimes what might seem a performance problem, isn't necessarily one.</p>
