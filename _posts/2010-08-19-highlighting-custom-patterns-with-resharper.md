---
layout: post
title: Highlighting Custom Patterns with ReSharper
categories: []
tags:
- ReSharper
status: publish
type: post
published: true
meta:
  _elasticsearch_indexed_on: '2010-08-19 15:33:00'
comments: true
---
<p>A new feature that has shipped with <a href="http://www.jetbrains.com/resharper">ReSharper</a> 5 is the Structural Search and Replace. It is a way for us to locate certain patterns in our code, and optionally replace them. However, it is more than just a Find and Replace. It allows us to somehow extend ReSharper’s inspection settings by offering us means to identify patterns and highlight them.</p>  <p>As many of you know, ReSharper offers a series of Suggestions, Hints, Warnings and Errors when it detects certain code patterns. For instance, when explicitly declaring a variable, ReSharper suggests you use var (<a href="http://hadihariri.com/blogengine/post/2009/11/20/var-improves-readability.aspx">and with good reason</a>)</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/a1.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="a" border="0" alt="a" src="http://hhariri.files.wordpress.com/2010/11/a_thumb1.png" width="399" height="67" /></a> </p>  <p>These are configurable, in that you can tell ReSharper whether you want them to be displayed as hints, suggestions, warnings or errors, which is done via ReSharper | Options | Inspection Severity</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/b1.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="b" border="0" alt="b" src="http://hhariri.files.wordpress.com/2010/11/b_thumb1.png" width="394" height="134" /></a> </p>  <p>Setting it to <strong>Show as error</strong> for instance will display a red (or whatever color you have configured) underlining and the right-hand side border will display the a Red box indicating an error in the file.</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/c1.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="c" border="0" alt="c" src="http://hhariri.files.wordpress.com/2010/11/c_thumb1.png" width="379" height="79" /></a> </p>  <p>If we now combine this with Solution Wide-Analysis, ReSharper will also indicate an error in the solution.</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/d1.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="d" border="0" alt="d" src="http://hhariri.files.wordpress.com/2010/11/d_thumb1.png" width="195" height="94" /></a> </p>  <p>&#160;</p>  <h3>Extending Inspections</h3>  <p>Have you ever encountered the following?</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/e1.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="e" border="0" alt="e" src="http://hhariri.files.wordpress.com/2010/11/e_thumb1.png" width="396" height="40" /></a> </p>  <p>This is a perfect candidate for using <strong>String.Format</strong>. How about this?</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/f1.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="f" border="0" alt="f" src="http://hhariri.files.wordpress.com/2010/11/f_thumb1.png" width="403" height="59" /></a> </p>  <p>Did you know <strong>StringBuilder </strong>has an <strong>AppendFormat</strong>? You might know that, I might, but maybe other developers don’t. It would be good to provide developers with a hint or suggestion that they could use AppendFormat. Up to version 5 of ReSharper, the inspections were limited to what ReSharper provided out of the box and the only thing we could do to extend this functionality was create/use a plug-in We can now use Structural Search and Replace to accomplish this. Let’s see how it works.</p>  <p>1. Open up a Solution (I’m using BlogEngine.NET but feel free to create your own with some sb.Append calls).</p>  <p>2. Select ReSharper | Tools | Pattern Catalog.</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/g.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="g" border="0" alt="g" src="http://hhariri.files.wordpress.com/2010/11/g_thumb.png" width="369" height="269" /></a> </p>  <p>By default, the Pattern Catalog is empty.</p>  <p>3. Click on the Add Pattern</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/h.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="h" border="0" alt="h" src="http://hhariri.files.wordpress.com/2010/11/h_thumb.png" width="370" height="278" /></a> </p>  <p>4. In this first sample, all we want to do is highlight code, so click on the Find button at the top to switch the dialog to Find mode only.</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/i.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="i" border="0" alt="i" src="http://hhariri.files.wordpress.com/2010/11/i_thumb.png" width="363" height="273" /></a> </p>  <p>The Search Pattern is what we’ll use to define what we are looking for. The Description is a text which helps us identify the pattern easily in the Catalog. The box on the right is for place holders which we’ll see in a moment.</p>  <p>5. Enter the following pattern in the Search Pattern editor</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/j.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="j" border="0" alt="j" src="http://hhariri.files.wordpress.com/2010/11/j_thumb.png" width="386" height="109" /></a> </p>  <p>What this does is indicate the pattern we are looking for. The values surrounded with $’s (same notation as that used in <a href="http://hadihariri.com/blogengine/post/2010/08/06/Templates-Galore-Live-Templates.aspx">Live Templates</a>) represent placeholders. A placeholder can be an expression, statement, type, etc. If it is red, it means it has not yet been defined (next step).</p>  <p>6. Click on the <strong>Add Placeholder </strong>button on the right box and select <strong>Expression</strong>, and enter the following values:</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/k.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="k" border="0" alt="k" src="http://hhariri.files.wordpress.com/2010/11/k_thumb.png" width="377" height="116" /></a> </p>  <p>We are indicating that the placeholder <strong>sb </strong>(first one used) is an expression of type System.Text.StringBuilder</p>  <p>7. Click on the <strong>Add Placeholder </strong>button to define the second placeholder, <strong>args</strong>. Select <strong>Argument </strong>and enter the following values:</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/l.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="l" border="0" alt="l" src="http://hhariri.files.wordpress.com/2010/11/l_thumb.png" width="377" height="108" /></a> </p>  <p>We can optionally indicate whether we want to limit the number of minimum or maximum arguments.</p>  <p>If both placeholders have been defined correctly, the Search pattern box should now look like this:</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/m.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="m" border="0" alt="m" src="http://hhariri.files.wordpress.com/2010/11/m_thumb.png" width="418" height="314" /></a> </p>  <p>(we’ve entered a description at the bottom)</p>  <p>8. We need to define the type of severity we want. In this case we want it to be marked as a Suggestion. We do that using the<strong> Pattern severity</strong> dropdown and then click <strong>Save</strong></p>  <p>Our Pattern Catalog should now be updated to reflect this new pattern</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/n.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="n" border="0" alt="n" src="http://hhariri.files.wordpress.com/2010/11/n_thumb.png" width="404" height="179" /></a> </p>  <p>9. At this stage we can either close the Patterns dialog or Search for a pattern. Let’s see what happens if we click <strong>Search now </strong>button.</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/o.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="o" border="0" alt="o" src="http://hhariri.files.wordpress.com/2010/11/o_thumb.png" width="398" height="191" /></a> </p>  <p>A Find Results window is displayed highlighting everywhere where ReSharper can find a pattern match. But what about the <strong>Pattern severity</strong>? Where does that come into play? Let’s double-click on one of the entries:</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/p.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="p" border="0" alt="p" src="http://hhariri.files.wordpress.com/2010/11/p_thumb.png" width="536" height="48" /></a> </p>  <p>See the highlighting of the <strong>sb.Append </strong>call? Set the Pattern Severity to Error and that will display in Red.</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/q.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="q" border="0" alt="q" src="http://hhariri.files.wordpress.com/2010/11/q_thumb.png" width="545" height="33" /></a> </p>  <p>Turn on Solution-Wide Analysis and that will list as an error!</p>  <p>So as we can see, the Structural Search (we haven’t replaced yet), allows us to monitor for certain code patterns in our projects. Potentially we could use it to detect certain code smells.</p>  <h3>Fixing things up</h3>  <p>Now that we have certain patterns located, and even highlighted, how do we go about fixing things? As we saw in the previous screenshots, we have a little icon pop up when placing the cursor on the line:</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/r.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="r" border="0" alt="r" src="http://hhariri.files.wordpress.com/2010/11/r_thumb.png" width="448" height="61" /></a> </p>  <p>This context action however doesn’t offer us anything in order to fix the situation, i.e. there is no <em>QuickFix</em>. The reason is obvious: ReSharper doesn’t know what a fix is. Let’s show it!</p>  <p>1. Open up the Patterns Catalog and Edit the previously created Pattern</p>  <p>2. Click on the <strong>Replace </strong>button to open up the Replace editor at the bottom</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/s.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="s" border="0" alt="s" src="http://hhariri.files.wordpress.com/2010/11/s_thumb.png" width="385" height="290" /></a> </p>  <p>3. Enter the following text in the <strong>Replace pattern </strong>section</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/t.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="t" border="0" alt="t" src="http://hhariri.files.wordpress.com/2010/11/t_thumb.png" width="395" height="102" /></a> </p>  <p>4. Provide a description (this is what the hint of the <em>QuickFix</em> will dispaly)</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/u.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="u" border="0" alt="u" src="http://hhariri.files.wordpress.com/2010/11/u_thumb.png" width="391" height="157" /></a> </p>  <p>5. Click on the <strong>Save </strong>button</p>  <p>Locate the previous <strong>sb.Append </strong>call and place the cursor on top of the line. We can now see a QuickFix icon appear (A red bulb in this case since it’s an Error)</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/v.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="v" border="0" alt="v" src="http://hhariri.files.wordpress.com/2010/11/v_thumb.png" width="426" height="73" /></a> </p>  <p>Alt+Enter and we’re done!</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/w.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="w" border="0" alt="w" src="http://hhariri.files.wordpress.com/2010/11/w_thumb.png" width="438" height="42" /></a> </p>  <p>&#160;</p>  <h3>Global Fix</h3>  <p>What we’ve just done is a manual local fix, that is, locate the offending entry and hit Alt+Enter to apply a <em>QuickFix. </em>We can do this at a global scope by using the Pattern Catalog tool window.</p>  <p>1. Undo the prefix fix (so as to have several instances)</p>  <p>2. Open up the <strong>Patterns Catalog</strong></p>  <p>3. Select the recently created Pattern and click on <strong>Search now</strong>. This time, instead of the Find Results dialog, we get a Replace dialog which displays all matching patterns and a <strong>Replace </strong>button</p>  <p><a href="http://hhariri.files.wordpress.com/2010/11/x.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="x" border="0" alt="x" src="http://hhariri.files.wordpress.com/2010/11/x_thumb.png" width="463" height="218" /></a> </p>  <p>4. We can select the entries we want replacing (by default all checked). Click <strong>Replace </strong></p>  <p>We’re done! ReSharper will now replace all occurrences. So we’ve applied a <em>QuickFix </em>globally.</p>  <p>&#160;</p>  <h3>There’s more</h3>  <p>What we’ve seen here is just a simple example of how to improve on a call to a class. We can of course do more complex searches, allowing us to identify code smells, etc. The pattern we created in this tutorial is actually included in a Patterns catalog you can download from the <a href="http://www.jetbrains.com/resharper/documentation/documentation.html">documentation section</a> of our web site (<a href="http://www.jetbrains.com/resharper/documentation/PublicPatternCatalog.zip">or click here for direct link</a>). All you need to do is unzip it and import the XML from the <strong>Patterns Catalog</strong> window (<strong>Import</strong> button). Currently, Pattern Catalogs are PER solution.</p>  <p>There’s much more planned for Structural Search and Replace in vNext and we are always happy to receive feedback, so please try it out, and let us know what you think.</p>
