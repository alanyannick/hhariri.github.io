---
layout: post
title: 'Writing plug-ins for ReSharper: Part 1 of Undefined'
categories: []
tags:
- ReSharper
status: publish
type: post
published: true
meta:
  _elasticsearch_indexed_on: '2010-01-12 14:24:00'
---
<p><a href="http://www.jetbrains.com/resharper">ReSharper</a> does a lot of things, but as they say, you can’t please <a href="http://twitter.com/mfeathers/status/7406170728">all the</a> people all of the time. However, one the great things about ReSharper is that it is quite extensible and there are already quite a number plug-ins available. Some of the better known ones are:</p> <p>- <a href="http://stylecopforresharper.codeplex.com">StyleCop for ReSharper</a> by <a href="http://howard.vanrooijen.co.uk/blog">Howard Van Rooijen</a></p> <p>- <a href="http://code.google.com/p/resharper-tdd-productivity-plugin/">TDD Productivity Plugin</a> by <a href="http://www.lostechies.com/blogs/hex/">Eric Hexter</a></p> <p>- <a href="http://github.com/agross/machine.specifications/tree/master/Libraries/ReSharper/">ReSharper Test Runner</a> for <a href="http://github.com/machine/machine.specifications">MSpec</a> by <a href="http://therightstuff.de/">Alexander Groß</a>&nbsp;</p> <p>and of course there is also the <a href="http://www.jetbrains.com/resharper/plugins/">repository of plug-ins available from the JetBrains site</a>, where many of these are located.</p> <p>Now I’m no expert on writing plug-ins for ReSharper, and the authors of the previous ones leave the bar quite high, but seeing that I actually now have the time to play with them, I’ve decided to do so by sharing my experiences with you in a series of blog posts.</p> <p>The ReSharper API is pretty extensive and can be overwhelming as I’ve been discovering, so I want to try and take it slowly. This might mean that at times, the code is not always complete and might be missing a few checks for example, but will come in due course.</p> <p>Everything that I’ll cover applies to <a href="http://www.jetbrains.com/resharper/beta/beta.html">version 5.0 which is currently in Beta</a>. There have been some changes from previous versions so if you’re working with 4.5 some of the code might not work.</p> <h3>&nbsp;</h3> <h3>The First Plug-in</h3> <p>I was initially intending to write a useless plug-in for the first demo that didn’t do much, but after talking to <a href="http://twitter.com/orangy/">Orangy</a> (aslo known as Ilya) who commented on a tweet Jeremy Skinner had posted a few days back:</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/130.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="1" border="0" alt="1" src="http://hhariri.files.wordpress.com/2010/11/1_thumb10.png" width="477" height="242"></a> </p> <p>we decided to use it as the first sample.</p> <p>I’m going to build up the sample over the next few series of posts, so the initial solution is not the ideal one or complete, but it will help introduce a few core concepts. Ideally this feature should be implemented as what’s known as a <em>QuickFix</em> but we’re first going to do it as a <em>ContextAction</em>.</p> <p>&nbsp;</p> <h3>ContextAction</h3> <p>So what exactly is a Context Action? It’s actions that can be applied based on the context (the name is quite descriptive). They shows up as items in a popup menu which is invoked using Alt+Enter (don’t use the mouse for this…it’s very unproductive).</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/225.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="2" border="0" alt="2" src="http://hhariri.files.wordpress.com/2010/11/2_thumb8.png" width="248" height="101"></a> </p> <p>What we want to do in this first version of the plug-in is to write a new action that makes methods that are public and not declared virtual, virtual, something NHibernate users would appreciate greatly. As mentioned previously, in this first version we’re going to add a context action.</p> <p><strong>1. Creating a plug-in assembly</strong></p> <p>ReSharper plug-ins are assemblies that are located in Plugins folder (by default %programFiles%\JetBrains\ReSharper\v5.0\Bin\Plugins). Each plug-in is in it’s own folder and doesn’t require any further registration. Therefore the first step is to create a class library which will host our context action.</p> <p><strong>2. Creating the Context Action Skeleton</strong></p> <p>In order to create a context action, we need to implement the <em>IContextAction </em>interface. This interface has one method <em>IsAvailable</em> which indicates to us if that particular action is available given the context, and a property of type <em>IBulbItem[]</em> which contains a series of bulb items. Each <em>IBulbItem</em> in turn has a property <em>Text</em> which is the text that appears next to the item in the context dropdown, and an <em>Execute </em>action, which is what happens when the item is selected. So as we can see, a context action can consist of more than one bulb item. An added benefit to this decoupling is the re-usability of bulb items. By implementing <em>IBulbItem</em>, we can potentially use it in more than once place (obviously if it makes sense).</p> <p>Many times however, we only want one bulb item per action, and to somehow simplify the process, we can inherit from the <em>BulbItemImpl </em>class. This class defines an abstract <em>Text </em>property that represents the text of the bulb item, and also has an <em>ExecuteTransaction</em> member which is where our code is executed. We’ll see the difference between this method and <em>Execute</em> shortly.</p> <p>&nbsp;</p> <div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:6bd1437c-d08c-453d-8bfd-63640ee43d54" class="wlWriterSmartContent"> <div style="border-bottom:#000080 1px solid;border-left:#000080 1px solid;font-family:'Courier New',courier,monospace;color:#000000;font-size:10pt;border-top:#000080 1px solid;border-right:#000080 1px solid;"> <div style="background:#dddddd 0 0;overflow:auto;"> <ol style="background:#000000 0 0;margin:0 0 0 2.5em;padding:0 0 0 5px;"> <li><span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">public</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">class</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#ffc66d;">MakeMethodVirtualContextActions</span><span style="background:#000000 0 0;color:#ffffff;">: </span><span style="background:#000000 0 0;color:#ffc66d;">BulbItemImpl</span><span style="background:#000000 0 0;color:#ffffff;">, </span><span style="background:#000000 0 0;color:#6897bb;">IContextAction</span>  <li><span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">protected</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">override</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#6897bb;">Action</span><span style="background:#000000 0 0;color:#ffffff;">&lt;</span><span style="background:#000000 0 0;color:#6897bb;">ITextControl</span><span style="background:#000000 0 0;color:#ffffff;">&gt; ExecuteTransaction(</span><span style="background:#000000 0 0;color:#6897bb;">ISolution</span><span style="background:#000000 0 0;color:#ffffff;"> solution, </span><span style="background:#000000 0 0;color:#6897bb;">IProgressIndicator</span><span style="background:#000000 0 0;color:#ffffff;"> progress)</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">throw</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">new</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#ffc66d;">NotImplementedException</span><span style="background:#000000 0 0;color:#ffffff;">();</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li>&nbsp; <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">public</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">override</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">string</span><span style="background:#000000 0 0;color:#ffffff;"> Text</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">get</span><span style="background:#000000 0 0;color:#ffffff;"> { </span><span style="background:#000000 0 0;color:#cc7832;">throw</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">new</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#ffc66d;">NotImplementedException</span><span style="background:#000000 0 0;color:#ffffff;">(); }</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li>&nbsp; <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">public</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">bool</span><span style="background:#000000 0 0;color:#ffffff;"> IsAvailable(</span><span style="background:#000000 0 0;color:#6897bb;">IUserDataHolder</span><span style="background:#000000 0 0;color:#ffffff;"> cache)</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">throw</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">new</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#ffc66d;">NotImplementedException</span><span style="background:#000000 0 0;color:#ffffff;">();</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li><span style="background:#000000 0 0;color:#ffffff;">}</span> </li></ol></div></div></div> <p>&nbsp;</p> <p>&nbsp;</p> <p>Before implementing any of the methods, there’s one thing we need to do. ReSharper requires that context action have a constructor with a parameter that implements a <em>IContextActionDataProvider</em>. This parameter is actually useful to use to provide information about the context as we’ll see shortly. Therefore, we need to add a constructor to the previous code (lines 6-9). Since our action is only for C#, we will use a <em>ICSharpContextActionDataProvider</em>. We then save this provider for later use (line 3). What we’re effectively doing here of course is nothing more than dependency injection. The plumbing (passing in the correct provider) is taken care of for us by ReSharper.</p> <p>&nbsp;</p> <div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:8ccd7ae7-ad88-4e81-a256-4357e662b61b" class="wlWriterSmartContent"> <div style="border-bottom:#000080 1px solid;border-left:#000080 1px solid;font-family:'Courier New',courier,monospace;color:#000000;font-size:10pt;border-top:#000080 1px solid;border-right:#000080 1px solid;"> <div style="background:#dddddd 0 0;overflow:auto;"> <ol style="background:#000000 0 0;margin:0 0 0 2.5em;padding:0 0 0 5px;"> <li><span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">public</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">class</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#ffc66d;">MakeMethodVirtualContextAction</span><span style="background:#000000 0 0;color:#ffffff;"> : </span><span style="background:#000000 0 0;color:#ffc66d;">BulbItemImpl</span><span style="background:#000000 0 0;color:#ffffff;">, </span><span style="background:#000000 0 0;color:#6897bb;">IContextAction</span>  <li><span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">readonly</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#6897bb;">ICSharpContextActionDataProvider</span><span style="background:#000000 0 0;color:#ffffff;"> _provider;</span>  <li>&nbsp; <li>&nbsp; <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">public</span><span style="background:#000000 0 0;color:#ffffff;"> MakeMethodVirtualContextAction(</span><span style="background:#000000 0 0;color:#6897bb;">ICSharpContextActionDataProvider</span><span style="background:#000000 0 0;color:#ffffff;"> provider)</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">_provider = provider;</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li><span style="background:#000000 0 0;color:#ffffff;"></span> <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">protected</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">override</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#6897bb;">Action</span><span style="background:#000000 0 0;color:#ffffff;">&lt;</span><span style="background:#000000 0 0;color:#6897bb;">ITextControl</span><span style="background:#000000 0 0;color:#ffffff;">&gt; ExecuteTransaction(</span><span style="background:#000000 0 0;color:#6897bb;">ISolution</span><span style="background:#000000 0 0;color:#ffffff;"> solution, </span><span style="background:#000000 0 0;color:#6897bb;">IProgressIndicator</span><span style="background:#000000 0 0;color:#ffffff;"> progress)</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">throw</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">new</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#ffc66d;">NotImplementedException</span><span style="background:#000000 0 0;color:#ffffff;">();</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li>&nbsp; <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">public</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">override</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">string</span><span style="background:#000000 0 0;color:#ffffff;"> Text</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">get</span><span style="background:#000000 0 0;color:#ffffff;"> { </span><span style="background:#000000 0 0;color:#cc7832;">throw</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">new</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#ffc66d;">NotImplementedException</span><span style="background:#000000 0 0;color:#ffffff;">(); }</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li>&nbsp; <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">public</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">bool</span><span style="background:#000000 0 0;color:#ffffff;"> IsAvailable(</span><span style="background:#000000 0 0;color:#6897bb;">IUserDataHolder</span><span style="background:#000000 0 0;color:#ffffff;"> cache)</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">throw</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">new</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#ffc66d;">NotImplementedException</span><span style="background:#000000 0 0;color:#ffffff;">();</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li><span style="background:#000000 0 0;color:#ffffff;">}</span> </li></ol></div></div></div> <p>&nbsp;</p> <p><strong>3. Defining Availability</strong></p> <p>The next step is to define when our action is available. In order to do so, we need to implement the <em>IsAvailable</em> method. In our case, we want to convert methods that are public and not virtual, to virtual. We therefore need to identify methods that are public and not virtual. We also need to filter out static methods. In order to get access to the current context we’re in, we can use the <em>provider</em> we injected in via the constructor. The <em>provider </em>has a <em>GetSelectedElement</em> method which corresponds to the element the caret is on. Since we’re interested in a method, we can invoke this function, requesting back a method declaration. If the caret is in the context of a method (i.e. header, body), it will return this information. If it’s not, it will return null.</p> <p>If we have a valid method declaration, the next step is to find out if it is public. We do that by invoking <em>GetAccessRights </em>[In later series we’ll see that further checks are necessary here]. If it is public, we then need to check whether it is a static method, an override or already virtual. Based on that, we return <em>true</em> or <em>false</em>, indicating whether the action is available in the current context.</p> <p>&nbsp;</p> <div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:08892768-5c0f-43d7-bcea-9d5c989520f2" class="wlWriterSmartContent"> <div style="border-bottom:#000080 1px solid;border-left:#000080 1px solid;font-family:'Courier New',courier,monospace;color:#000000;font-size:10pt;border-top:#000080 1px solid;border-right:#000080 1px solid;"> <div style="background:#dddddd 0 0;overflow:auto;"> <ol style="background:#000000 0 0;margin:0 0 0 2.5em;padding:0 0 0 5px;"> <li><span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">public</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">bool</span><span style="background:#000000 0 0;color:#ffffff;"> IsAvailable(</span><span style="background:#000000 0 0;color:#6897bb;">IUserDataHolder</span><span style="background:#000000 0 0;color:#ffffff;"> cache)</span>  <li><span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">var</span><span style="background:#000000 0 0;color:#ffffff;"> item = _provider.GetSelectedElement&lt;</span><span style="background:#000000 0 0;color:#6897bb;">IMethodDeclaration</span><span style="background:#000000 0 0;color:#ffffff;">&gt;(</span><span style="background:#000000 0 0;color:#cc7832;">false</span><span style="background:#000000 0 0;color:#ffffff;">, </span><span style="background:#000000 0 0;color:#cc7832;">true</span><span style="background:#000000 0 0;color:#ffffff;">);</span>  <li>&nbsp; <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">if</span><span style="background:#000000 0 0;color:#ffffff;"> (item != </span><span style="background:#000000 0 0;color:#cc7832;">null</span><span style="background:#000000 0 0;color:#ffffff;">)</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">var</span><span style="background:#000000 0 0;color:#ffffff;"> accessRights = item.GetAccessRights();</span>  <li>&nbsp; <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">if</span><span style="background:#000000 0 0;color:#ffffff;"> (accessRights == </span><span style="background:#000000 0 0;color:#bf82d7;">AccessRights</span><span style="background:#000000 0 0;color:#ffffff;">.PUBLIC &amp;&amp; !item.IsStatic &amp;&amp; !item.IsVirtual &amp;&amp; !item.IsOverride)</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">return</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">true</span><span style="background:#000000 0 0;color:#ffffff;">;</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">return</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">false</span><span style="background:#000000 0 0;color:#ffffff;">;</span>  <li><span style="background:#000000 0 0;color:#ffffff;">}</span> </li></ol></div></div></div> <p>&nbsp;</p> <p><strong>4. Performing the action</strong></p> <p>When the action is available and the user selects it, what we need to do is make the method virtual. This is done in the <em>ExecuteTransaction</em> method. Since we are going to modify the code, we need to make sure that the file is writable. Normally this would be done by invoking a call to a method named <em>EnsureWritable. </em>However, inside the method <em>ExecuteTransaction</em>, this is done for us, so we don’t have to worry about it. This is one of the differences between <em>ExecuteTransaction </em>and <em>IBulbItem.Execute</em>.</p> <p>So how do we go about modifying code in ReSharper? Well remember that refactoring code is ReSharper’s daily bread. It’s what it does. As such, there’s a ton of infrastructure in place to allow us to do modify code easily. In fact, making a method virtual is as easy as calling a method, as shown below.</p> <div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:1204f257-3604-47b1-8adc-681470f842d7" class="wlWriterSmartContent"> <div style="border-bottom:#000080 1px solid;border-left:#000080 1px solid;font-family:'Courier New',courier,monospace;color:#000000;font-size:10pt;border-top:#000080 1px solid;border-right:#000080 1px solid;"> <div style="background:#dddddd 0 0;overflow:auto;"> <ol style="background:#000000 0 0;margin:0 0 0 2.5em;padding:0 0 0 5px;"> <li><span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">protected</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">override</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#6897bb;">Action</span><span style="background:#000000 0 0;color:#ffffff;">&lt;</span><span style="background:#000000 0 0;color:#6897bb;">ITextControl</span><span style="background:#000000 0 0;color:#ffffff;">&gt; ExecuteTransaction(</span><span style="background:#000000 0 0;color:#6897bb;">ISolution</span><span style="background:#000000 0 0;color:#ffffff;"> solution, </span><span style="background:#000000 0 0;color:#6897bb;">IProgressIndicator</span><span style="background:#000000 0 0;color:#ffffff;"> progress)</span>  <li><span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">var</span><span style="background:#000000 0 0;color:#ffffff;"> method = _provider.GetSelectedElement&lt;</span><span style="background:#000000 0 0;color:#6897bb;">IMethodDeclaration</span><span style="background:#000000 0 0;color:#ffffff;">&gt;(</span><span style="background:#000000 0 0;color:#cc7832;">false</span><span style="background:#000000 0 0;color:#ffffff;">, </span><span style="background:#000000 0 0;color:#cc7832;">true</span><span style="background:#000000 0 0;color:#ffffff;">);</span>  <li>&nbsp; <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">if</span><span style="background:#000000 0 0;color:#ffffff;"> (method != </span><span style="background:#000000 0 0;color:#cc7832;">null</span><span style="background:#000000 0 0;color:#ffffff;">)</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">method.SetVirtual(</span><span style="background:#000000 0 0;color:#cc7832;">true</span><span style="background:#000000 0 0;color:#ffffff;">);</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">}</span>  <li>&nbsp; <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">return</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">null</span><span style="background:#000000 0 0;color:#ffffff;">;</span>  <li><span style="background:#000000 0 0;color:#ffffff;">}</span> </li></ol></div></div></div> <p>&nbsp;</p> <p><strong>5. Testing the plug-in</strong></p> <p>The only thing left to do is test that it works (writing unit tests for plug-ins is something we’ll cover in the future). One option is to copy the assembly to the plug-in folder for ReSharper and restart Visual Studio. However, in order to be able to debug it, what we can do is set the project properties to start an external program, which is non other than <em>devenv.exe</em>, and pass as parameter to it <em>/ReSharper.Plugin &lt;Path_to_Plugin_Assembly&gt;</em>, instructing ReSharper to load a specific plug-in.</p> <p>How does ReSharper know which classes in the assembly are context actions? The easiest way is to decorate these with the <em>ContextAction </em>attribute</p> <p>&nbsp;</p> <div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:816a2e31-64f6-4d00-80aa-ab30a90b5de4" class="wlWriterSmartContent"> <div style="border-bottom:#000080 1px solid;border-left:#000080 1px solid;font-family:'Courier New',courier,monospace;color:#000000;font-size:10pt;border-top:#000080 1px solid;border-right:#000080 1px solid;"> <div style="background:#dddddd 0 0;overflow:auto;"> <ol style="background:#000000 0 0;margin:0 0 0 2em;padding:0 0 0 5px;"> <li><span style="background:#000000 0 0;color:#ffffff;">[</span><span style="background:#000000 0 0;color:#ffc66d;">ContextAction</span><span style="background:#000000 0 0;color:#ffffff;">(Group=</span><span style="background:#000000 0 0;color:#a5c25c;">"C#"</span><span style="background:#000000 0 0;color:#ffffff;">, Name = </span><span style="background:#000000 0 0;color:#a5c25c;">"MakeMethodVirtual"</span><span style="background:#000000 0 0;color:#ffffff;">, Description = </span><span style="background:#000000 0 0;color:#a5c25c;">"Adds context action to make methods virtual"</span><span style="background:#000000 0 0;color:#ffffff;">)]</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span><span style="background:#000000 0 0;color:#cc7832;">public</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#cc7832;">class</span><span style="background:#000000 0 0;color:#ffffff;"> </span><span style="background:#000000 0 0;color:#ffc66d;">MakeMethodVirtualContextAction</span><span style="background:#000000 0 0;color:#ffffff;"> : </span><span style="background:#000000 0 0;color:#ffc66d;">BulbItemImpl</span><span style="background:#000000 0 0;color:#ffffff;">, </span><span style="background:#000000 0 0;color:#6897bb;">IContextAction</span>  <li>&nbsp;&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;">{</span>  <li>&nbsp;&nbsp; <span style="background:#000000 0 0;color:#ffffff;"></span></li></ol></div></div></div> <p>&nbsp;</p> <p>This information is also what appears under ReSharper –&gt; C# –&gt; Context Actions</p> <p>&nbsp;</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/320.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="3" border="0" alt="3" src="http://hhariri.files.wordpress.com/2010/11/3_thumb8.png" width="410" height="249"></a> </p> <p>Now all that’s left is to try it out. Write a new class, add a few methods and check to see it’s all working correctly.</p> <p>&nbsp;</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/419.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="4" border="0" alt="4" src="http://hhariri.files.wordpress.com/2010/11/4_thumb8.png" width="442" height="192"></a> </p> <p>Public static method (not available)</p> <p>&nbsp;</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/519.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="5" border="0" alt="5" src="http://hhariri.files.wordpress.com/2010/11/5_thumb8.png" width="441" height="127"></a> </p> <p>Private method (not available)</p> <p>&nbsp;</p> <p><a href="http://hhariri.files.wordpress.com/2010/11/617.png"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="6" border="0" alt="6" src="http://hhariri.files.wordpress.com/2010/11/6_thumb6.png" width="438" height="210"></a> </p> <p>Public method (option available) </p> <h3>What’s next?</h3> <p>In this first part we’ve seen the basics of writing plug-ins for ReSharper. In the next blog post, we’ll extend the example to also include properties and we’ll change it to be a <em>QuickFix</em> as opposed to a context action. This means that we’ll get some nice highlighting by ReSharper telling us something can be changed (similar to when you have something named incorrectly for instance), thus being more *in your face*.</p> <p>There’s so much more to see than what’s here, and gradually we’ll drill more into each of the different areas, examining parameters, return values, etc. Until then, Happy ReSharping (did I just coin that? Too lame?)</p>
